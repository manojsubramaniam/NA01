name: Build and Export IPA

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      
    - name: Set up Xcode
      uses: actions/setup-xcode@v2
      with:
        xcode-version: '12.x' # Replace with your desired Xcode version
    
    - name: Install CocoaPods
      run: |
        gem install cocoapods --pre
        pod install
    
    - name: Set Default Scheme
      run: |
        scheme_list=$(xcodebuild -list -json | tr -d "\n")
        default=$(echo "$scheme_list" | python3 -c "import sys, json; print(json.load(sys.stdin)['project']['targets'][0])")
        echo "$default" > default
        echo "Using default scheme: $default"
    
    - name: Build Archive
      run: xcodebuild archive -workspace SignIn.xcworkspace -scheme "$(<default)" -archivePath "$RUNNER_TEMP/SignIn.xcarchive" CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO
    
    - name: Export IPA
      run: xcodebuild -exportArchive -archivePath "$RUNNER_TEMP/SignIn.xcarchive/Products/Applications/SignIn.app" -exportOptionsPlist ExportOptions.plist -exportPath "$RUNNER_TEMP/IPA" CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO
